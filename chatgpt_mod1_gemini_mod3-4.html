<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³å‹•ä½œåˆ†æã‚¢ãƒ—ãƒª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:'Inter','Helvetica Neue',Arial,sans-serif;}
    input[type="range"]::-webkit-slider-thumb,
    input[type="range"]::-moz-range-thumb{
      width:20px;height:20px;border-radius:50%;
      background:#fb923c;border:2px solid #fff;cursor:pointer;box-shadow:0 0 2px rgba(0,0,0,.3)
    }
    .analysis-canvas{border:1px solid #e5e7eb;background:#f9fafb}
    /* === ãƒˆãƒªãƒŸãƒ³ã‚° UI === */
    #trimCanvas{position:absolute;inset:0;z-index:20;cursor:crosshair}
    .handle{fill:#f97316;stroke:#fff;stroke-width:2}
  </style>
</head>

<body class="bg-gradient-to-br from-orange-100 via-amber-100 to-yellow-100 text-gray-800 p-4 min-h-screen flex items-center justify-center">
<div class="container mx-auto bg-white/70 p-6 rounded-xl shadow-2xl w-full">

<!-- 0. ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header class="text-center mb-8">
  <h1 class="text-4xl font-bold text-orange-600">ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³å‹•ä½œåˆ†æ</h1>
  <p class="text-gray-600 mt-1">å‹•ç”»ã‹ã‚‰é¸æ‰‹ã®å‹•ãã‚’æ‰ãˆã€è»Œè·¡ã¨ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã§å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>
</header>

<!-- 1. å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
<section class="mb-8 p-4 border border-orange-200 rounded-lg bg-white/50">
  <h2 class="text-2xl font-semibold mb-3 text-orange-500">1. å‹•ç”»ã®æº–å‚™</h2>
  <input type="file" id="fileInput" accept="video/*" class="block w-full text-sm text-slate-500
    file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0
    file:text-sm file:font-semibold file:bg-orange-100 file:text-orange-700
    hover:file:bg-orange-200 disabled:opacity-50 transition-colors" disabled>
  <p id="loadingTxt" class="text-sm text-gray-500 mt-2">
     AIãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™... åˆå›ã¯æ•°ç§’ï½æ•°åç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
  </p>

  <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-start relative">
    <!-- ã‚ªãƒªã‚¸ãƒŠãƒ« -->
    <div>
      <h3 class="text-lg font-medium text-gray-700 mb-1">ã‚ªãƒªã‚¸ãƒŠãƒ«å‹•ç”»</h3>
      <video id="video" controls class="w-full rounded-md shadow-md aspect-video hidden bg-gray-200"></video>
    </div>
    <!-- æ¨å®šçµæœ + ãƒˆãƒªãƒŸãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¬ã‚¤ -->
    <div class="relative">
      <h3 class="text-lg font-medium text-gray-700 mb-1">å§¿å‹¢æ¨å®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</h3>
      <canvas id="poseCanvas" class="w-full rounded-md shadow-md aspect-video hidden bg-gray-200"></canvas>
      <!-- è§’ãƒ‰ãƒ©ãƒƒã‚°ç”¨ã‚ªãƒ¼ãƒãƒ¬ã‚¤ -->
      <canvas id="trimCanvas" class="hidden"></canvas>
    </div>
  </div>
</section>

<!-- 2. éŒ²ç”»åˆ¶å¾¡ -->
<section class="mb-8 p-4 border border-orange-200 rounded-lg text-center bg-white/50">
  <h2 class="text-2xl font-semibold mb-3 text-orange-500">2. éŒ²ç”»ã¨åº§æ¨™å–å¾—</h2>
  <button id="startButton" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-md disabled:opacity-50 transition-transform hover:scale-105" disabled>éŒ²ç”»é–‹å§‹</button>
  <button id="stopButton"  class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md disabled:opacity-50 ml-2 transition-transform hover:scale-105" disabled>éŒ²ç”»åœæ­¢</button>
  <a id="downloadLink" href="#" download="badminton_analysis.webm"
     class="hidden mt-4 inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform hover:scale-105">
     éŒ²ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  </a>
</section>

<!-- 3. ç§»å‹•åˆ†æ -->
<section id="analysisSection" class="mb-6 p-4 border border-orange-200 rounded-lg hidden bg-white/50">
  <h2 class="text-2xl font-semibold mb-3 text-orange-500">3. ç§»å‹•åˆ†æçµæœ</h2>
  <button id="analyzeButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md w-full mb-4 transition-transform hover:scale-105" disabled>
    ç§»å‹•åˆ†æã‚’é–‹å§‹ãƒ»æ›´æ–°
  </button>

  <!-- â˜… è¿½åŠ : ã‚³ãƒ¼ãƒˆãƒˆãƒªãƒŸãƒ³ã‚° -->
  <div id="trimSection" class="hidden mb-6">
    <h3 class="text-xl font-semibold text-orange-500">ã‚³ãƒ¼ãƒˆã«åˆã‚ã›ã¦ãƒˆãƒªãƒŸãƒ³ã‚°</h3>
    <p class="text-sm text-gray-600 mb-2">4ã¤ã®è§’ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§èª¿æ•´ â†’ <span class="font-semibold">è£œæ­£ã‚’é©ç”¨</span></p>
    <div class="flex gap-4 flex-wrap">
      <button id="trimToggle" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
      <button id="applyTrim"  class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hidden">è£œæ­£ã‚’é©ç”¨</button>
      <button id="cancelTrim" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hidden">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- å¯è¦–åŒ–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div id="visualizationControls" class="mt-4 hidden">
    <label for="timeSlider" class="block mb-1 text-sm font-medium text-gray-700">è¡¨ç¤ºã™ã‚‹æ™‚é–“ç¯„å›²:</label>
    <input type="range" id="timeSlider" min="0" max="100" value="100" step="0.1" class="w-full h-3 bg-orange-200 rounded-lg appearance-none cursor-pointer">
    <div class="flex justify-between text-xs text-gray-500 mt-1">
      <span id="sliderMinTime">0.0s</span>
      <span id="sliderCurrentTimeLabel" class="font-semibold">ç¾åœ¨: <span id="sliderCurrentTime">0.0s</span></span>
      <span id="sliderMaxTime">0.0s</span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
      <div>
        <h3 class="text-xl font-semibold mb-2 text-orange-500">ç§»å‹•è»Œè·¡</h3>
        <p class="text-xs text-gray-500 mb-1">é’: å·¦è¶³é¦–, èµ¤: å³è¶³é¦–</p>
        <canvas id="trajectoryCanvas" class="w-full aspect-video analysis-canvas rounded-md shadow"></canvas>
      </div>
      <div>
        <h3 class="text-xl font-semibold mb-2 text-orange-500">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h3>
        <p class="text-xs text-gray-500 mb-1">æ»åœ¨é »åº¦ãŒé«˜ã„ã»ã©èµ¤ãè¡¨ç¤º</p>
        <canvas id="heatmapCanvas" class="w-full aspect-video analysis-canvas rounded-md shadow"></canvas>
      </div>
    </div>
  </div>
</section>
</div>

<!-- ======================== JavaScript ======================== -->
<script type="module">
/* ---------- import libs ---------- */
import { PoseLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.skypack.dev/@mediapipe/tasks-vision@0.10.10";
import createPT from "https://cdn.skypack.dev/perspective-transform";   // é€è¦–å¤‰æ›è¡Œåˆ—ç”Ÿæˆ

/* ---------- DOM refs ---------- */
const fileInput   = document.getElementById('fileInput');
const video       = document.getElementById('video');
const poseCanvas  = document.getElementById('poseCanvas');
const trimCanvas  = document.getElementById('trimCanvas');
const startButton = document.getElementById('startButton');
const stopButton  = document.getElementById('stopButton');
const downloadLink= document.getElementById('downloadLink');
const loadingTxt  = document.getElementById('loadingTxt');

const analysisSection  = document.getElementById('analysisSection');
const analyzeButton    = document.getElementById('analyzeButton');
const visualizationControls = document.getElementById('visualizationControls');
const timeSlider = document.getElementById('timeSlider');
const sliderMinTime = document.getElementById('sliderMinTime');
const sliderCurrentTime = document.getElementById('sliderCurrentTime');
const sliderMaxTime = document.getElementById('sliderMaxTime');

const trajectoryCanvas = document.getElementById('trajectoryCanvas');
const heatmapCanvas    = document.getElementById('heatmapCanvas');

/* --- trimming UI --- */
const trimSection = document.getElementById('trimSection');
const trimToggle  = document.getElementById('trimToggle');
const applyTrim   = document.getElementById('applyTrim');
const cancelTrim  = document.getElementById('cancelTrim');

/* ---------- Canvas ctx ---------- */
let ctxPose       = poseCanvas.getContext('2d');
let ctxTrim       = trimCanvas.getContext('2d');
let ctxTrajectory = trajectoryCanvas.getContext('2d');
let ctxHeatmap    = heatmapCanvas.getContext('2d');

/* ---------- Globals ---------- */
let poseLandmarker=null, drawingUtilsPose=null, runningMode='VIDEO';
let mediaRecorder, recordedChunks=[], stream=null;
let anklePositions=[];          // [{time,leftAnkle:{x,y},rightAnkle:{x,y}}]
let videoDuration=0, lastVideoTime=-1;
const HEATMAP_GRID_SIZE = 25;

/* --- trimming state --- */
let trimMode = false;
let courtTransform = null;      // perspective-transform instance
let handles   = [];             // [{x,y}] in px relative to canvas
let dragging  = -1;             // handle index being dragged

/* ============================================================= */
/*                        1. PoseLandmarker                      */
/* ============================================================= */
async function initPoseLandmarker(){
  try{
    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/wasm");
    poseLandmarker = await PoseLandmarker.createFromOptions(vision,{
      baseOptions:{
        modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",
        delegate:"GPU"
      },
      runningMode, numPoses:1
    });
    loadingTxt.textContent="ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ã€‚å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
    fileInput.disabled=false;
  }catch(e){
    console.error(e);
    loadingTxt.textContent="ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚";
  }
}
initPoseLandmarker();

/* ============================================================= */
/*                       2. Video èª­ã¿è¾¼ã¿                       */
/* ============================================================= */
fileInput.addEventListener('change', e=>{
  const file=e.target.files[0]; if(!file) return;
  const url=URL.createObjectURL(file);
  video.src=url; video.style.display='block'; poseCanvas.style.display='block';

  video.onloadedmetadata=()=>{
    videoDuration=video.duration;

    /* Canvas ã‚µã‚¤ã‚ºçµ±ä¸€ */
    [poseCanvas,trimCanvas,trajectoryCanvas,heatmapCanvas].forEach(c=>{
      c.width=video.videoWidth; c.height=video.videoHeight;
    });
    drawingUtilsPose = new DrawingUtils(ctxPose);

    /* ãƒˆãƒªãƒŸãƒ³ã‚°åˆæœŸåŒ– */
    resetHandles();

    startButton.disabled=false;
    analysisSection.classList.add('hidden');
    visualizationControls.classList.add('hidden');
    trimSection.classList.add('hidden');
    courtTransform=null;
    anklePositions=[]; recordedChunks=[];
    loadingTxt.textContent="å‹•ç”»æº–å‚™å®Œäº†ã€‚éŒ²ç”»é–‹å§‹ã§ãã¾ã™ã€‚";
  };
});

/* ============================================================= */
/*                 3. Pose æ¨å®š (video â†’ canvas)                 */
/* ============================================================= */
async function drawFrame(){
  if(!video || video.paused || video.ended || video.readyState<2){
    requestAnimationFrame(drawFrame); return;
  }
  ctxPose.clearRect(0,0,poseCanvas.width,poseCanvas.height);
  ctxPose.drawImage(video,0,0,poseCanvas.width,poseCanvas.height);

  if(poseLandmarker && video.currentTime!==lastVideoTime){
    lastVideoTime = video.currentTime;
    const now = performance.now();
    poseLandmarker.detectForVideo(video,now,res=>{
      if(res.landmarks?.length){
        const lmk=res.landmarks[0];
        drawingUtilsPose.drawConnectors(lmk,PoseLandmarker.POSE_CONNECTIONS,{color:'#FF8A65',lineWidth:2});
        drawingUtilsPose.drawLandmarks(lmk,{color:'#FFAB91',radius:3});

        /* éŒ²ç”»ä¸­ãªã‚‰ä½ç½®ä¿å­˜ (æ­£è¦åŒ–åº§æ¨™ 0-1) */
        if(mediaRecorder?.state==="recording"){
          anklePositions.push({
            time:video.currentTime,
            leftAnkle : {...lmk[27]},
            rightAnkle: {...lmk[28]}
          });
        }
      }
    });
  }

  /* ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã®ã‚ªãƒ¼ãƒãƒ¬ã‚¤ */
  if(trimMode) drawTrimOverlay();

  requestAnimationFrame(drawFrame);
}
video.addEventListener('play',()=>{lastVideoTime=-1;requestAnimationFrame(drawFrame);});
video.addEventListener('ended',()=>{if(mediaRecorder?.state==='recording') stopRecording();});

/* ============================================================= */
/*                     4. MediaRecorder åˆ¶å¾¡                     */
/* ============================================================= */
startButton.addEventListener('click',()=>{
  stream = poseCanvas.captureStream?.(30) || video.captureStream?.(30);
  if(!stream){loadingTxt.textContent="ãƒ–ãƒ©ã‚¦ã‚¶ãŒéŒ²ç”»ã«æœªå¯¾å¿œã§ã™ã€‚";return;}

  anklePositions=[]; recordedChunks=[];
  try{ mediaRecorder = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9'}); }
  catch{ mediaRecorder = new MediaRecorder(stream,{mimeType:'video/webm'}); }

  mediaRecorder.ondataavailable=e=>{ if(e.data.size) recordedChunks.push(e.data); };
  mediaRecorder.onstop = ()=>{
    const blob = new Blob(recordedChunks,{type:'video/webm'});
    downloadLink.href=URL.createObjectURL(blob); downloadLink.classList.remove('hidden');

    /* UI æ›´æ–° */
    analysisSection.classList.remove('hidden');
    analyzeButton.disabled=false;
    trimSection.classList.remove('hidden');   // â˜… ãƒˆãƒªãƒŸãƒ³ã‚° UI å‡ºç¾
    visualizationControls.classList.add('hidden');

    const maxTime = anklePositions.at(-1)?.time ?? videoDuration;
    timeSlider.max = timeSlider.value = maxTime.toFixed(1);
    sliderMaxTime.textContent = sliderCurrentTime.textContent = `${maxTime.toFixed(1)}s`;
    sliderMinTime.textContent="0.0s";
    loadingTxt.textContent="éŒ²ç”»å®Œäº†ã€‚åˆ†æã§ãã¾ã™ã€‚";
  };
  mediaRecorder.start();
  video.play();
  startButton.disabled=true;  stopButton.disabled=false;  analyzeButton.disabled=true;
  loadingTxt.textContent="éŒ²ç”»ä¸­...";
});
function stopRecording(){
  if(mediaRecorder?.state==='recording') mediaRecorder.stop();
  stream?.getTracks().forEach(t=>t.stop());
  startButton.disabled=false; stopButton.disabled=true;
}
stopButton.addEventListener('click',stopRecording);

/* ============================================================= */
/*                      5. ç§»å‹•åˆ†æ æç”»                         */
/* ============================================================= */
analyzeButton.addEventListener('click',()=>{
  if(!anklePositions.length){
    loadingTxt.textContent="åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚éŒ²ç”»ã—ã¦ãã ã•ã„ã€‚";return;
  }
  visualizationControls.classList.remove('hidden');
  drawAnalysis(parseFloat(timeSlider.value));
  loadingTxt.textContent="ç§»å‹•åˆ†æçµæœã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚";
});
timeSlider.addEventListener('input',()=>{
  sliderCurrentTime.textContent=`${parseFloat(timeSlider.value).toFixed(1)}s`;
  if(!visualizationControls.classList.contains('hidden')) drawAnalysis(parseFloat(timeSlider.value));
});

/* ------- 5-1  è£œæ­£é–¢æ•° -------- */
function correctPoint(pt){
  if(!courtTransform) return {...pt};
  const [nx,ny] = courtTransform.transform([pt.x,pt.y]); // 0-1,0-1 ã¸
  return {x: nx, y: ny};
}

/* ------- 5-2  Trajectory / Heatmap -------- */
function drawAnalysis(currentTime){
  ctxTrajectory.clearRect(0,0,trajectoryCanvas.width,trajectoryCanvas.height);
  ctxHeatmap.clearRect(0,0,heatmapCanvas.width,heatmapCanvas.height);

  const data = anklePositions.filter(p=>p.time<=currentTime);
  if(!data.length){
    ctxTrajectory.fillText("ãƒ‡ãƒ¼ã‚¿ãªã—",trajectoryCanvas.width/2,trajectoryCanvas.height/2);
    ctxHeatmap.fillText("ãƒ‡ãƒ¼ã‚¿ãªã—",heatmapCanvas.width/2,heatmapCanvas.height/2);
    return;
  }
  drawTrajectory(data);
  drawHeatmap(data);
}
function drawTrajectory(list){
  ctxTrajectory.lineWidth=2;

  /* blue å·¦ */
  ctxTrajectory.strokeStyle='rgba(59,130,246,.8)';
  ctxTrajectory.beginPath();
  let first=true;
  list.forEach(p=>{
    const l = p.leftAnkle? correctPoint(p.leftAnkle):null;
    if(l){
      const x=l.x*trajectoryCanvas.width, y=l.y*trajectoryCanvas.height;
      first?ctxTrajectory.moveTo(x,y):ctxTrajectory.lineTo(x,y);
      first=false;
    }else first=true;
  });
  ctxTrajectory.stroke();

  /* red å³ */
  ctxTrajectory.strokeStyle='rgba(239,68,68,.8)';
  ctxTrajectory.beginPath();
  first=true;
  list.forEach(p=>{
    const r = p.rightAnkle? correctPoint(p.rightAnkle):null;
    if(r){
      const x=r.x*trajectoryCanvas.width, y=r.y*trajectoryCanvas.height;
      first?ctxTrajectory.moveTo(x,y):ctxTrajectory.lineTo(x,y);
      first=false;
    }else first=true;
  });
  ctxTrajectory.stroke();
}
function drawHeatmap(list){
  const gw = heatmapCanvas.width/HEATMAP_GRID_SIZE,
        gh = heatmapCanvas.height/HEATMAP_GRID_SIZE;
  const grid = Array.from({length:HEATMAP_GRID_SIZE},()=>Array(HEATMAP_GRID_SIZE).fill(0));
  let max=0;
  list.forEach(p=>{
    ['leftAnkle','rightAnkle'].forEach(k=>{
      const a=p[k]; if(!a) return;
      const c=correctPoint(a);
      const gx=Math.min(HEATMAP_GRID_SIZE-1,Math.floor(c.x*HEATMAP_GRID_SIZE));
      const gy=Math.min(HEATMAP_GRID_SIZE-1,Math.floor(c.y*HEATMAP_GRID_SIZE));
      max=Math.max(max,++grid[gy][gx]);
    });
  });
  if(!max) return;
  for(let y=0;y<HEATMAP_GRID_SIZE;y++){
    for(let x=0;x<HEATMAP_GRID_SIZE;x++){
      if(!grid[y][x]) continue;
      const t=grid[y][x]/max;
      const r=Math.floor(255*Math.min(1,t*1.5));
      const g=Math.floor(255*Math.max(0,(1-t*1.5)));
      ctxHeatmap.fillStyle=`rgba(${r},${g},0,${Math.max(.1,t*.8)})`;
      ctxHeatmap.fillRect(x*gw,y*gh,gw,gh);
    }
  }
}

/* ============================================================= */
/*                     6. ã‚³ãƒ¼ãƒˆãƒˆãƒªãƒŸãƒ³ã‚° UI                     */
/* ============================================================= */
function resetHandles(){
  handles=[
    {x:0,y:0},
    {x:poseCanvas.width,y:0},
    {x:poseCanvas.width,y:poseCanvas.height},
    {x:0,y:poseCanvas.height},
  ];
}
function drawTrimOverlay(){
  ctxTrim.clearRect(0,0,trimCanvas.width,trimCanvas.height);

  ctxTrim.lineWidth=2; ctxTrim.strokeStyle='#f97316aa';
  ctxTrim.beginPath();
  ctxTrim.moveTo(handles[0].x,handles[0].y);
  for(let i=1;i<4;i++) ctxTrim.lineTo(handles[i].x,handles[i].y);
  ctxTrim.closePath(); ctxTrim.stroke();

  handles.forEach(h=>{
    ctxTrim.beginPath();
    ctxTrim.arc(h.x,h.y,7,0,Math.PI*2);
    ctxTrim.fillStyle='#f97316'; ctxTrim.fill();
    ctxTrim.strokeStyle='#fff'; ctxTrim.stroke();
  });
}
function nearestHandleIndex(mx,my){
  const r=10**2;
  for(let i=0;i<handles.length;i++){
    const dx=handles[i].x-mx, dy=handles[i].y-my;
    if(dx*dx+dy*dy<r) return i;
  }
  return -1;
}
/* pointer events */
trimCanvas.addEventListener('pointerdown',e=>{
  if(!trimMode) return;
  const rect=trimCanvas.getBoundingClientRect();
  dragging=nearestHandleIndex(e.clientX-rect.left,e.clientY-rect.top);
});
window.addEventListener('pointermove',e=>{
  if(!trimMode||dragging===-1) return;
  const rect=trimCanvas.getBoundingClientRect();
  handles[dragging].x=Math.max(0,Math.min(rect.width ,e.clientX-rect.left));
  handles[dragging].y=Math.max(0,Math.min(rect.height,e.clientY-rect.top));
});
window.addEventListener('pointerup',()=>dragging=-1);

/* --- ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ --- */
trimToggle.addEventListener('click',()=>{
  trimMode=true;
  trimCanvas.classList.remove('hidden');
  trimToggle.classList.add('hidden');
  applyTrim.classList.remove('hidden');
  cancelTrim.classList.remove('hidden');
});
cancelTrim.addEventListener('click',()=>{
  trimMode=false;
  trimCanvas.classList.add('hidden');
  trimToggle.classList.remove('hidden');
  applyTrim.classList.add('hidden');
  cancelTrim.classList.add('hidden');
});
applyTrim.addEventListener('click',()=>{
  /* handles(px) -> 0-1 æ­£è¦åŒ–src, dst = å®Ÿã‚³ãƒ¼ãƒˆçŸ©å½¢ */
  const src=handles.map(h=>[h.x/poseCanvas.width , h.y/poseCanvas.height]);
  const dst=[[0,0],[1,0],[1,1],[0,1]];
  courtTransform=createPT(src,dst); // ğŸ”¸ homography è¨ˆç®— (perspective-transform)
  trimMode=false;
  trimCanvas.classList.add('hidden');
  trimToggle.classList.remove('hidden');
  applyTrim.classList.add('hidden');
  cancelTrim.classList.add('hidden');
  loadingTxt.textContent="è£œæ­£ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚è»Œè·¡/ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’å†ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚";
});
</script>
</body>
</html>